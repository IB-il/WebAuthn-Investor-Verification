{% extends "base.html" %}

{% block content %}
<div class="verification-card">
    <div class="verification-icon">××™× ×˜×¨×§×˜×™×‘ ×™×©×¨××œ</div>
    
    <h1 class="main-heading">××™××•×ª ×–×”×•×ª</h1>
    <p class="subheading">××‘×˜×— ××ª ×—×©×‘×•×Ÿ ×”×”×©×§×¢×•×ª ×©×œ×š ×‘×××¦×¢×•×ª ××™××•×ª ×‘×™×•××˜×¨×™</p>
    
    <div id="status" class="status-container">
        <div class="status-text">××•×›×Ÿ ×œ××™××•×ª ×”×–×”×•×ª ×©×œ×š</div>
        <div class="status-subtitle">×”×©×ª××© ×‘××™××•×ª ×”×‘×™×•××˜×¨×™ ×©×œ ×”××›×©×™×¨ ×©×œ×š</div>
    </div>
    
    <div class="biometric-icons">
        <div class="biometric-icon">ğŸ“±</div>
        <div class="biometric-icon">ğŸ‘†</div>
        <div class="biometric-icon">ğŸ‘¤</div>
    </div>
    
    <div class="qr-section" id="qrSection">
        <div class="qr-title">×¤×ª×— ×‘×˜×œ×¤×•×Ÿ ×”× ×™×™×“</div>
        <div id="qrcode"></div>
        <div class="qr-instructions">
            ×”×©×ª××© ×‘×§×™×©×•×¨ ×œ××˜×” ×œ×¤×ª×™×—×” ×‘×˜×œ×¤×•×Ÿ ×”× ×™×™×“<br>
            ×”××™××•×ª ×™×ª×‘×¦×¢ ×‘××›×©×™×¨ ×”× ×™×™×“ ×¢× Face ID ××• Touch ID
        </div>
    </div>
    
    <button id="verifyBtn" class="verify-button" onclick="startVerification()">
        ×××ª ××ª ×”×–×”×•×ª ×©×œ×™
    </button>
    
    <div class="security-notice">
        <h4>×”××‘×˜×—×” ×•×”×¤×¨×˜×™×•×ª ×©×œ×š</h4>
        <ul class="security-points">
            <li>×”× ×ª×•× ×™× ×”×‘×™×•××˜×¨×™×™× ×©×œ×š ×œ× ×™×•×¦××™× ××”××›×©×™×¨ ×©×œ×š</li>
            <li>×”×¦×¤× ×” ×‘×¨××” ×‘× ×§××™×ª ××’× ×” ×¢×œ ×›×œ ×”×ª×§×©×•×¨×ª</li>
            <li>×”××™××•×ª ××¡×ª×™×™× ×ª×•×š ×©× ×™×•×ª, ×œ× ×“×§×•×ª</li>
        </ul>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const token = "{{ token }}";
    
    function showStatus(message, subtitle = '', type = 'info') {
        const statusContainer = document.getElementById('status');
        const statusText = statusContainer.querySelector('.status-text') || statusContainer;
        const statusSubtitle = statusContainer.querySelector('.status-subtitle');
        
        statusText.textContent = message;
        if (statusSubtitle && subtitle) {
            statusSubtitle.textContent = subtitle;
        }
        
        // Remove all status classes
        statusContainer.classList.remove('info', 'success', 'error');
        // Add the appropriate class
        statusContainer.classList.add(type);
        
        // Animate biometric icons based on status
        const icons = document.querySelectorAll('.biometric-icon');
        icons.forEach((icon, index) => {
            setTimeout(() => {
                if (type === 'info' && message.includes('biometric')) {
                    icon.classList.add('active');
                } else {
                    icon.classList.remove('active');
                }
            }, index * 200);
        });
    }
    
    function showSuccess(message, subtitle = '×”××™××•×ª ×”×•×©×œ× ×‘×”×¦×œ×—×”') {
        showStatus(message, subtitle, 'success');
        
        const button = document.getElementById('verifyBtn');
        button.innerHTML = 'âœ“ ×”×–×”×•×ª ××•××ª×”';
        button.disabled = true;
        
        // Celebrate with all icons active
        document.querySelectorAll('.biometric-icon').forEach(icon => {
            icon.classList.add('active');
        });
    }
    
    function showError(message, subtitle = '×× × × ×¡×” ×©×•×‘') {
        showStatus(message, subtitle, 'error');
        document.getElementById('verifyBtn').disabled = false;
    }
    
    async function startVerification() {
        if (!window.PublicKeyCredential) {
            showError('××™××•×ª ×‘×™×•××˜×¨×™ ×œ× × ×ª××š', '×”××›×©×™×¨ ×”×–×” ×œ× ×ª×•××š ×‘××™××•×ª ×‘×™×•××˜×¨×™');
            return;
        }
        
        // Mobile-first: Check if running on mobile device
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        if (!isMobile) {
            // Desktop user - show mobile link
            showMobileLink();
            return;
        }
        
        showStatus('××›×™×Ÿ ××™××•×ª ×‘×™×•××˜×¨×™...', '××ª×—×‘×¨ ×œ×©×¨×ª ×××•×‘×˜×—');
        document.getElementById('verifyBtn').disabled = true;
        
        try {
            // Get WebAuthn options from server
            const optionsResponse = await fetch(`https://webauthn-investor.azurewebsites.net/api/webauthn/options?token=${token}`);
            if (!optionsResponse.ok) {
                throw new Error('×”×—×™×‘×•×¨ ×œ×©×¨×ª × ×›×©×œ');
            }
            
            const options = await optionsResponse.json();
            
            // Convert base64url to ArrayBuffer for WebAuthn
            function base64urlToBuffer(base64url) {
                const base64 = base64url.replace(/-/g, '+').replace(/_/g, '/');
                const padded = base64 + '='.repeat((4 - base64.length % 4) % 4);
                const binary = atob(padded);
                const buffer = new ArrayBuffer(binary.length);
                const view = new Uint8Array(buffer);
                for (let i = 0; i < binary.length; i++) {
                    view[i] = binary.charCodeAt(i);
                }
                return buffer;
            }
            
            function bufferToBase64url(buffer) {
                const binary = String.fromCharCode(...new Uint8Array(buffer));
                const base64 = btoa(binary);
                return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
            }
            
            // If this is registration (new user)
            if (options.isRegistration) {
                const publicKeyCredentialCreationOptions = {
                    challenge: base64urlToBuffer(options.challenge),
                    rp: options.rp,
                    user: {
                        ...options.user,
                        id: base64urlToBuffer(options.user.id)
                    },
                    pubKeyCredParams: options.pubKeyCredParams,
                    authenticatorSelection: options.authenticatorSelection,
                    timeout: 60000,
                    attestation: options.attestation || 'none'
                };
                
                showStatus('×”×©×œ× ××™××•×ª ×‘×™×•××˜×¨×™', '×’×¢ ×‘×—×™×™×©×Ÿ ×˜×‘×™×¢×ª ×”××¦×‘×¢ ××• ×”×©×ª××© ×‘-Face ID', 'info');
                const credential = await navigator.credentials.create({
                    publicKey: publicKeyCredentialCreationOptions
                });
                
                // Send registration result to server
                const registrationResponse = await fetch(`https://webauthn-investor.azurewebsites.net/api/webauthn/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        token: token,
                        credential: {
                            id: credential.id,
                            rawId: bufferToBase64url(credential.rawId),
                            type: credential.type,
                            response: {
                                clientDataJSON: bufferToBase64url(credential.response.clientDataJSON),
                                attestationObject: bufferToBase64url(credential.response.attestationObject)
                            }
                        }
                    })
                });
                
                if (registrationResponse.ok) {
                    showSuccess('×”×–×”×•×ª ××•××ª×” ×‘×”×¦×œ×—×”!', '×”×¨×™×©×•× ×”×‘×™×•××˜×¨×™ ×©×œ×š × ×¨×©× ×‘×”×¦×œ×—×”');
                    // Update server that verification is complete
                    await fetch(`https://webauthn-investor.azurewebsites.net/api/verification/complete`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ token: token })
                    });
                } else {
                    const errorData = await registrationResponse.json();
                    const serverError = errorData.error || '×¨×™×©×•× ×”×¨×™×©×•× ×”×‘×™×•××˜×¨×™ × ×›×©×œ';
                    throw new Error(serverError);
                }
            } else {
                // Authentication for existing user
                const publicKeyCredentialRequestOptions = {
                    challenge: base64urlToBuffer(options.challenge),
                    allowCredentials: options.allowCredentials ? options.allowCredentials.map(cred => ({
                        ...cred,
                        id: base64urlToBuffer(cred.id)
                    })) : [],
                    userVerification: options.userVerification || 'required',
                    timeout: 60000
                };
                
                showStatus('×××ª ×‘×‘×™×•××˜×¨×™×”', '×”×©×ª××© ×‘×˜×‘×™×¢×ª ×”××¦×‘×¢ ×”×¨×©×•××” ××• ×‘-Face ID', 'info');
                const credential = await navigator.credentials.get({
                    publicKey: publicKeyCredentialRequestOptions
                });
                
                // Send authentication result to server
                const authResponse = await fetch(`https://webauthn-investor.azurewebsites.net/api/webauthn/authenticate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        token: token,
                        credential: {
                            id: credential.id,
                            rawId: bufferToBase64url(credential.rawId),
                            type: credential.type,
                            response: {
                                clientDataJSON: bufferToBase64url(credential.response.clientDataJSON),
                                authenticatorData: bufferToBase64url(credential.response.authenticatorData),
                                signature: bufferToBase64url(credential.response.signature),
                                userHandle: credential.response.userHandle ? bufferToBase64url(credential.response.userHandle) : null
                            }
                        }
                    })
                });
                
                if (authResponse.ok) {
                    showSuccess('×‘×¨×•×š ×”×©×‘!', '×”××™××•×ª ×”×•×©×œ× ×‘×”×¦×œ×—×”');
                    // Update server that verification is complete
                    await fetch(`https://webauthn-investor.azurewebsites.net/api/verification/complete`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ token: token })
                    });
                } else {
                    throw new Error('××™××•×ª ×”×–×”×•×ª × ×›×©×œ');
                }
            }
            
        } catch (error) {
            console.error('WebAuthn error:', error);
            if (error.name === 'NotAllowedError') {
                showError('×”××™××•×ª ×‘×•×˜×œ', '×‘×™×˜×œ×ª ××ª ×”××™××•×ª ×”×‘×™×•××˜×¨×™');
            } else if (error.name === 'InvalidStateError') {
                showError('×”××›×©×™×¨ ×œ× ××•×›×Ÿ', '×× × ×•×•×“× ×©×”××™××•×ª ×”×‘×™×•××˜×¨×™ ××•×¤×¢×œ');
            } else {
                showError('×”××™××•×ª × ×›×©×œ', error.message);
            }
            document.getElementById('verifyBtn').disabled = false;
        }
    }
    
    function showMobileLink() {
        const currentUrl = window.location.href;
        const qrSection = document.getElementById('qrSection');
        const qrCodeDiv = document.getElementById('qrcode');
        
        // Show the section
        qrSection.classList.add('show');
        
        // Simple mobile link display
        qrCodeDiv.innerHTML = `
            <div style="padding: 30px; background: #f0f9ff; border: 3px solid #303e90; border-radius: 16px; color: #303e90; text-align: center; line-height: 1.6;">
                <div style="font-size: 24px; margin-bottom: 20px;">ğŸ“±</div>
                <div style="font-size: 18px; font-weight: 600; margin-bottom: 16px;">×¤×ª×— ×‘×˜×œ×¤×•×Ÿ ×”× ×™×™×“ ×©×œ×š</div>
                <a href="${currentUrl}" target="_blank" style="display: inline-block; background: #303e90; color: white; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: 600; font-size: 16px; margin: 10px 0;">
                    ×¤×ª×— ××ª ×”×§×™×©×•×¨ ×‘×˜×œ×¤×•×Ÿ
                </a>
                <div style="margin-top: 16px; font-size: 14px; opacity: 0.8;">
                    ××• ×”×¢×ª×§ ××ª ×”×§×™×©×•×¨ ×•×©×œ×— ×œ×¢×¦××š ×‘×”×•×“×¢×”
                </div>
                <div style="margin-top: 12px; padding: 12px; background: white; border-radius: 8px; font-family: monospace; font-size: 12px; word-break: break-all; color: #666; border: 1px solid #e5e7eb;">
                    ${currentUrl}
                </div>
            </div>
        `;
        
        // Update status and hide verification button
        showStatus('×¤×ª×— ××ª ×”×§×™×©×•×¨ ×‘×˜×œ×¤×•×Ÿ ×”× ×™×™×“', '×”×©×ª××© ×‘×›×¤×ª×•×¨ ××• ×”×¢×ª×§ ××ª ×”×§×™×©×•×¨ ×œ××˜×”', 'info');
        document.getElementById('verifyBtn').style.display = 'none';
    }
    
    // Initialize
    showStatus('××•×›×Ÿ ×œ××™××•×ª ×”×–×”×•×ª ×©×œ×š', '×”×§×© ×¢×œ ×”×›×¤×ª×•×¨ ×œ××˜×” ×›×“×™ ×œ×”×ª×—×™×œ');
</script>
{% endblock %}